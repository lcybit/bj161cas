<!DOCTYPE html>
<html>

<head>
<title>排课信息展示</title>
<link rel="stylesheet" href="/plugin/layui/css/layui.css" />
<script src="/plugin/jquery/jquery.js"></script>
<script src="/plugin/jquery/jquery.serializejson.js"></script>
<script src="/plugin/jsrender/jsrender.js"></script>
</head>

<body>
  <div class="layui-container" style="width:100%;">
    <button class="layui-btn layui-btn-normal" id="exportExcel" onclick="exportExcel()">
      <i class="layui-icon">&#xe601;</i>导出
    </button>
    <button class="layui-btn layui-btn-normal" id="listAdjustment" style="display:none" onclick="listAdjustment()">
      <i class="layui-icon">&#xe60a;</i>调整列表
    </button>
    <button class="layui-btn layui-btn-danger" id="undoAdjust" onclick="undoAdjust()">
      <i class="layui-icon">&#xe603;</i>撤销
    </button>
    <button class="layui-btn" id="saveAdjustment" onclick="saveAdjustment()">
      <i class="layui-icon">&#xe638;</i>保存
    </button>
    <form class="layui-form layui-form-pane" id="adjustment" style="display:none">
      <div class="layui-form-item">
        <label class="layui-form-label">课表ID</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="scheduleId" id="scheduleId">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">起始教学周</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="startWeek" id="startWeek">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">持续周数</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="duration" id="duration">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">类型</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="type" id="type">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">甲ID</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="firstId" id="firstId">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">乙ID</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="secondId" id="secondId">
        </div>
      </div>
    </form>
    <div class="layui-row" id="scheduleView"></div>
  </div>
  <script id="tmpl-scheduleView" type="text/x-jsrender">
	<div class="layui-col-md6">
      <blockquote class="layui-elem-quote" id="classScheduleTitle">班级课表</blockquote>
      <div class="layui-col-md12" id="classSchedule" style="overflow-x:hidden; overflow-y:auto">
        <div class="layui-col-md12">
          {{props tclassWeekViewMap tmpl="#tmpl-tclassWeekView" /}}
        </div>
      </div>
    </div>
	<div class="layui-col-md6">
      <blockquote class="layui-elem-quote">教师课表</blockquote>
      <div class="layui-col-md12" id="teacherSchedule" style="overflow-x:hidden; overflow-y:auto">
        <div class="layui-col-md12">
          {{props teacherWeekViewMap tmpl="#tmpl-teacherWeekView" /}}
        </div>
      </div>
    </div>
  </script>
  <script id="tmpl-tclassWeekView" type="text/x-jsrender">
    <div class="layui-col-md6">
      <table class="layui-table" id="{{:key}}" lay-size="sm">
      {{for prop}}
        <tbody>
          {{include titleView tmpl="#tmpl-tclassTitleView" /}}
          <tr>
            <th rowspan="2"></th>
            <th colspan="5">上午</th>
            <th colspan="3">下午</th>
          </tr>
          <tr>
            <th>早</th>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
            <th>5</th>
            <th>6</th>
            <th>7</th>
          </tr>
			{{for dayViewList tmpl="#tmpl-tclassDayView" /}}
        </tbody>
      </table>
      <table class="layui-table" lay-size="sm">
        <tr>
          {{props planViewMap tmpl="#tmpl-tclassPlanView" /}}
          <td class="layui-col-md2" style="cursor:pointer" onclick="clickRemoveBtn(this)">删除</td>
        </tr>
      </table>
      {{/for}}
    </div>
    {{if (#getIndex() + 1) % 2 == 0}}</div><div class="layui-col-md12">{{/if}}
  </script>
  <script id="tmpl-teacherWeekView" type="text/x-jsrender">
    <div class="layui-col-md6">
      <table class="layui-table" id="{{:key}}" lay-size="sm"">
      {{for prop}}
        <tbody>
          {{include titleView tmpl="#tmpl-teacherTitleView" /}}
          <tr>
            <th rowspan="2"></th>
            <th colspan="5">上午</th>
            <th colspan="3">下午</th>
          </tr>
          <tr>
            <th>早</th>
            <th>1</th>
            <th>2</th>
            <th>3</th>
            <th>4</th>
            <th>5</th>
            <th>6</th>
            <th>7</th>
          </tr>
			{{for dayViewList tmpl="#tmpl-teacherDayView" /}}
        </tbody>
      </table>
      <table class="layui-table" lay-size="sm">
        <tr>
          {{props planViewMap tmpl="#tmpl-teacherPlanView" /}}
        </tr>
      </table>
      {{/for}}
    </div>
    {{if (#getIndex() + 1) % 2 == 0}}</div><div class="layui-col-md12">{{/if}}
  </script>
  <script id="tmpl-tclassTitleView" type="text/x-jsrender">
    <tr>
      <th colspan="3">{{:tclassName}}</th>
      <th colspan="3">{{:teacherName}}</th>
      <th colspan="3">{{:startDate}}</th>
    </tr>
  </script>
  <script id="tmpl-teacherTitleView" type="text/x-jsrender">
    <tr>
      <th colspan="1">{{:courseName}}</th>
      <th colspan="2">{{:gradeName}}</th>
      <th colspan="3">{{:teacherName}}</th>
      <th colspan="3">{{:startDate}}</th>
    </tr>
  </script>
  <script id="tmpl-tclassDayView" type="text/x-jsrender">
    <tr>
      <td>{{:#index +1}}</td>
      {{for arrangedPeriodViewList tmpl="#tmpl-tclassPeriodView" /}}
    </tr>
  </script>
  <script id="tmpl-teacherDayView" type="text/x-jsrender">
    <tr>
      <td>{{:#index +1}}</td>
      {{for arrangedPeriodViewList tmpl="#tmpl-teacherPeriodView" /}}
    </tr>
  </script>
  <script id="tmpl-tclassPeriodView" type="text/x-jsrender">
	<td id="{{:periodViewId}}"
      style="cursor:pointer"
      onclick="clickPeriodView(this, event, [
        {{for arrangementList ~length = arrangementList.length}}
          {'courseId':{{:course.courseId}}}
          {{if #index < ~length - 1}},{{/if}}
        {{/for}}
      ])">
        {{for arrangementList ~jumpList = jumpViewIdList}}
          <span onclick="jumpToView(event, '{{:~jumpList[#index]}}')">{{:course.shortName}}</span>
        {{/for}}
    </td>
  </script>
  <script id="tmpl-teacherPeriodView" type="text/x-jsrender">
	<td id="{{:periodViewId}}"
      style="cursor:pointer"
      onclick="clickPeriodView(this, event, [
        {{for arrangementList ~length = arrangementList.length}}
          {'tclassId':{{:tclass.tclassId}}}
          {{if #index < ~length - 1}},{{/if}}
        {{/for}}
      ])">
        {{for arrangementList ~jumpList = jumpViewIdList}}
          <span onclick="jumpToView(event, '{{:~jumpList[#index]}}')">{{:tclass.shortName}}</span>
        {{/for}}
    </td>
  </script>
  <script id="tmpl-tclassPlanView" type="text/x-jsrender">
    <td class="layui-col-md2" id="{{:key}}" style="cursor:pointer" onclick="clickPlanView(this, event)">
    {{for prop}}
      {{for plan.course.shortName}}
        {{if #data.length > 1}}
          <span style="font-size:9px">{{:#data}}</span>
        {{else}}
          {{:#data}}
        {{/if}}
      {{/for}}
    {{:plan.periodNum - arrangedNum}}</td>
    {{/for}}
    {{if (#getIndex() + 1) % 6 == 0}}</tr><tr>{{/if}}
  </script>
  <script id="tmpl-teacherPlanView" type="text/x-jsrender">
    <td class="layui-col-md2" id="{{:key}}" style="cursor:pointer" onclick="clickPlanView(this, event)">
    {{for prop}}
      {{for plan.tclass.shortName}}
        {{if #data.length > 2}}
          <span style="font-size:9px">{{:#data}}</span>
        {{else}}
          {{:#data}}
        {{/if}}
      {{/for}}
      {{:plan.periodNum - arrangedNum}}</td>
    {{/for}}
    {{if (#getIndex() + 1) % 6 == 0}}</tr><tr>{{/if}}
  </script>
  <script>
    var form = layui.form;
    var table = layui.table;
    var element = layui.element;
    var layer = layui.layer;
  
    var status = 'normal';
    var scheduleId = sessionStorage.getItem('currentScheduleId');
  
    $(document).ready(function() {
      $('#scheduleId').attr('value', scheduleId);
      $('#startWeek').attr('value', 0);
      $('#duration').attr('value', 0);
      display();
    });
  
    function display() {
      $.ajax({
        async : false,
        url : '/schedule/display/' + scheduleId,
        type : 'GET',
        success : function(scheduleView) {
          $('#scheduleView').html($.templates('#tmpl-scheduleView').render(scheduleView));
          $('th,td').css('font-size', '14px').css('padding', '2px 2px').css('text-align', 'center');
          $('th').css('width', '11%');
          setBackground();
          form.render();
          //var scheduleHeight = $(window).height() - $('#classScheduleTitle').height() - $('#exportExcel').height();
          $('#classSchedule').css('max-height', '460px');
          $('#teacherSchedule').css('max-height', '460px');
        }
      });
    }
  
    function getConflictList() {
      $.ajax({
        async : false,
        url : '/arrangement/getConflictList',
        type : 'POST',
        dataType : 'json',
        contentType : 'application/json',
        data : JSON.stringify($('#arrangementView').serializeJSON()),
        success : function(conflictMap) {

        }
      });
    }
  
    function clickPeriodView(cell, event, arrangementList) {
      if (event.ctrlKey == false) {
        return;
      }
      var periodView = $(cell);
      var periodViewId = periodView.attr('id');
      switch (status) {
      case 'add':
        if (!isNull(arrangementList)) {
          alert('请选择空白位置添加！');
          return;
        }
        endAdd(periodViewId);
        break;
      case 'normal':
        if (isNull(arrangementList)) {
          alert('请选择非空位置交换！')
        }
        startSwap(periodViewId);
        break;
      case 'remove':
        if (isNull(arrangementList)) {
          alert('请选择非空位置删除！');
          return;
        }
        endRemove(periodViewId, arrangementList[0].courseId);
        break;
      case 'swap':
        if (isNull(arrangementList)) {
          alert('请选择非空位置交换！')
        }
        endSwap(periodViewId);
        break;
      default:
        break;
      }
    }
  
    function clickPlanView(cell, event) {
      if (event.ctrlKey == false) {
        return;
      }
      var planView = $(cell);
      var planViewId = planView.attr('id');
      switch (status) {
      case 'add':
        reset();
        break;
      case 'normal':
      case 'remove':
      case 'swap':
        planView.css('background-color', 'blue');
        startAdd(planViewId);
        break;
      default:
        break;
      }
    }
  
    function clickRemoveBtn(cell) {
      var removeBtn = $(cell);
      switch (status) {
      case 'remove':
        reset();
        break;
      case 'add':
      case 'normal':
      case 'swap':
        removeBtn.css('background-color', 'red');
        startRemove();
        break;
      default:
        break;
      }
    }
  
    function startSwap(id) {
      status = 'swap';
      $('#type').attr('value', 0);
      $('#firstId').attr('value', id);
    }
  
    function endSwap(id) {
      status = 'normal';
      $('#secondId').attr('value', id);
      var adjustmentId = recordAdjustment();
      doAdjust(adjustmentId);
  
    }
  
    function startAdd(id) {
      status = 'add';
      $('#type').attr('value', 1);
      $('#firstId').attr('value', id);
    }
  
    function endAdd(id) {
      $('#secondId').attr('value', id);
      var adjustmentId = recordAdjustment();
      doAdjust(adjustmentId);
    }
  
    function startRemove() {
      status = 'remove';
      $('#type').attr('value', 2);
    }
  
    function endRemove(id1, id2) {
      $('#firstId').attr('value', 'c' + id2);
      $('#secondId').attr('value', id1);
      var adjustmentId = recordAdjustment();
      doAdjust(adjustmentId);
    }
    
    function jumpToView(event, viewId) {
      if (event.ctrlKey == false) {
        $('#' + viewId)[0].scrollIntoView();
        return;
      }
    }
  
    function reset() {
      status = 'normal';
    }
  
    function recordAdjustment() {
      var adjustmentId = '';
      $.ajax({
        async : false,
        url : '/adjustments',
        type : 'POST',
        dataType : 'json',
        contentType : 'application/json',
        data : JSON.stringify($('#adjustment').serializeJSON()),
        success : function(response) {
          adjustmentId = response.data;
          alert('课程调整已记录！');
        }
      });
      return adjustmentId;
    }
  
    function doAdjust(adjustmentId) {
      $.ajax({
        async : false,
        url : '/arrangement/doAdjust/' + adjustmentId,
        type : 'POST',
        success : function(response) {
          display();
        }
      });
    }
  
    function undoAdjust() {
      $.ajax({
        async : false,
        url : '/adjustments/latest?scheduleId=' + scheduleId,
        type : 'GET',
        success : function(response) {
          var adjustmentId = response.data;
          $.ajax({
            async : false,
            url : '/arrangement/undoAdjust/' + adjustmentId,
            type : 'POST',
            success : function(response) {
              $.ajax({
                async : false,
                url : '/adjustments/' + adjustmentId,
                type : 'DELETE',
                success : function(response) {
                  alert('撤销成功！');
                  display();
                }
              });
            }
          });
        }
      });
    }
  
    function isNull(obj) {
      return null == obj || '' == obj;
    }
  
    function exportExcel() {
      $.ajax({
        async : false,
        url : '/schedule/export/' + scheduleId,
        type : 'GET',
        success : function(response) {
          alert('导出成功！');
        }
      })
    }
  
    function listAdjustment() {
      layer.open({
        type : 2,
        id : 'list',
        title : '调整信息',
        content : '/html/schedule/adjustment/display.html',
        area : [ '300px', '500px' ],
        offset : 'r',
        shade : 0,
        shadeClose : true
      });
    }
    
    function saveAdjustment() {
      $.ajax({
        async : false,
        url : '/arrangement/saveAdjustment/' + scheduleId,
        type : 'POST',
        success : function(response) {
          alert('保存完毕！');
        }
      })
    }
    
    function setBackground() {
      var allCell = $('td[id]');
      allCell.css('background-color', '');
      allCell.css('color', '');
      $.ajax({
        async : false,
        url : '/arrangement/getBackground',
        type : 'GET',
        success : function(backgroundMap) {
          var periodView;
          $.each(backgroundMap.conflicting, function(key, value) {
            periodView = $('#' + key);
            if (value == 0) {
              periodView.css('background-color', 'red');
            }
          });
          $.each(backgroundMap.adjusted, function(key, value) {
            periodView = $('#' + key);
            if (value == 0) {
              periodView.css('background-color', 'yellow');
            }
          });
        }
      })
    }
  </script>
</body>

</html>
