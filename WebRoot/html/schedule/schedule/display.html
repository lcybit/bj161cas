<!DOCTYPE html>
<html>

<head>
<title>排课信息展示</title>
<link rel="stylesheet" href="/plugin/layui/css/layui.css" />
<script src="/plugin/jquery/jquery.js"></script>
<script src="/plugin/jquery/jquery.serializejson.js"></script>
<script src="/plugin/jsrender/jsrender.js"></script>
</head>

<body>
  <div class="layui-container" style="width:100%;">
    <form class="layui-form layui-form-pane" id="arrangementView" method="get" style="">
      <div class="layui-form-item">
        <label class="layui-form-label">当前类型:</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="type" id="currentType">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">当前课表ID:</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="scheduleId" id="currentScheduleId">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">当前课时ID:</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="periodId" id="currentPeriodId">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">当前课程ID:</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="courseId" id="currentCourseId">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">当前教室ID:</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="roomId" id="currentRoomId">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">当前班级ID:</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="tclassId" id="currentTclassId">
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">当前教师ID:</label>
        <div class="layui-input-block">
          <input class="layui-input" type="text" name="teacherId" id="currentTeacherId">
        </div>
      </div>
    </form>
    <div class="layui-row" id="scheduleView"></div>
  </div>
  <script id="tmpl-scheduleView" type="text/x-jsrender">
	<div class="layui-col-md6">
      <div class="layui-input-block layui-form">
        {{for courseList tmpl="#tmpl-courseList" /}}
      </div>
      {{for tclassWeekViewList tmpl="#tmpl-tclassWeekView" /}}
	</div>
	<div class="layui-col-md6">
      <div class="layui-input-block layui-form">
        {{for tclassList tmpl="#tmpl-tclassList" /}}
      </div>
      {{for teacherWeekViewList tmpl="#tmpl-teacherWeekView" /}}
	</div>
  </script>
  <script id="tmpl-courseList" type="text/x-jsrender">
    <input type="radio" name="course" lay-filter="course" value="{{:courseId}}" title="{{:name}}"">
  </script>
  <script id="tmpl-tclassList" type="text/x-jsrender">
    <input type="radio" name="tclass" lay-filter="tclass" value="{{:tclassId}}" title="{{:name}}"">
  </script>
  <script id="tmpl-tclassWeekView" type="text/x-jsrender">
    <div class="layui-col-md6">
      <table class="layui-table" lay-size="sm">
        <tbody>
          <tr>
            <td rowspan="2"></td>
            <td colspan="{{:#parent.parent.data.schedule.forenoon}}">上午</td>
            <td colspan="{{:#parent.parent.data.schedule.afternoon}}">下午</td>
          </tr>
          <tr>
            <td>早</td>
            <td>1</td>
            <td>2</td>
            <td>3</td>
            <td>4</td>
            <td>5</td>
            <td>6</td>
            <td>7</td>
          </tr>
			{{for dayViewList tmpl="#tmpl-tclassDayView" /}}
        </tbody>
      </table>
      <table class="layui-table" lay-size="sm">
        <tr>
          {{for planViewList tmpl="#tmpl-tclassPlanView" /}}
        </tr>
      </table>
    </div>
  </script>
  <script id="tmpl-teacherWeekView" type="text/x-jsrender">
    <div class="layui-col-md6">
      <table class="layui-table" lay-size="sm">
        <tbody>
          <tr>
            <td rowspan="2"></td>
            <td colspan="{{:#parent.parent.data.schedule.forenoon}}">上午</td>
            <td colspan="{{:#parent.parent.data.schedule.afternoon}}">下午</td>
          </tr>
          <tr>
            <td>早</td>
            <td>1</td>
            <td>2</td>
            <td>3</td>
            <td>4</td>
            <td>5</td>
            <td>6</td>
            <td>7</td>
          </tr>
			{{for dayViewList tmpl="#tmpl-teacherDayView" /}}
        </tbody>
      </table>
      <table class="layui-table" lay-size="sm">
        <tr>
          {{for planViewList tmpl="#tmpl-teacherPlanView" /}}
        </tr>
      </table>
    </div>
  </script>
  <script id="tmpl-tclassDayView" type="text/x-jsrender">
    <tr>
      <td>{{:#getIndex() +1}}</td>
      {{for periodViewList tmpl="#tmpl-tclassPeriodView" /}}
    </tr>
  </script>
  <script id="tmpl-teacherDayView" type="text/x-jsrender">
    <tr>
      <td>{{:#getIndex() +1}}</td>
      {{for periodViewList tmpl="#tmpl-teacherPeriodView" /}}
    </tr>
  </script>
  <script id="tmpl-tclassPeriodView" type="text/x-jsrender">
	<td id="{{:periodViewId}}"
        style="cursor:pointer"
        onclick="clickTable({'type':'tclass',
							 'periodId':'{{:arrangement.period.periodId}}',
							 'tclassId':'{{:arrangement.tclass.tclassId}}',
							 'courseId':'{{:arrangement.course.courseId}}'})">
      {{:arrangement.course.name}}</td>
  </script>
  <script id="tmpl-teacherPeriodView" type="text/x-jsrender">
	<td id="{{:periodViewId}}"
        style="cursor:pointer"
        onclick="clickTable({'type':'teacher',
							 'periodId':'{{:arrangement.period.periodId}}',
							 'teacherId':'{{:arrangement.teacher.teacherId}}',
							 'tclassId':'{{:arrangement.tclass.tclassId}}'})">
      {{:arrangement.tclass.name}}</td>
  </script>
  <script id="tmpl-tclassPlanView" type="text/x-jsrender">
    <td>{{:plan.course.name}}{{:plan.periodNum-arrangedNum}}</td>
  </script>
  <script id="tmpl-teacherPlanView" type="text/x-jsrender">
    <td>{{:plan.tclass.name}}{{:plan.course.name}}{{:plan.periodNum-arrangedNum}}</td>
  </script>
  <script>
      var form = layui.form;
  
      $(document).ready(function() {
        var scheduleId = sessionStorage.getItem('currentScheduleId');
        $('#currentScheduleId').attr('value', scheduleId);
        display();
      });
  
      function display() {
        var scheduleId = sessionStorage.getItem('currentScheduleId');
        $.ajax({
          async : false,
          url : '/schedule/display/' + scheduleId,
          type : 'GET',
          success : function(scheduleView) {
            $('#scheduleView').html($.templates('#tmpl-scheduleView').render(scheduleView));
            form.on('radio(course)', function(course) {
              var courseId = course.value;
              $('#currentCourseId').attr('value', courseId);
              clearConflict();
              clearTclassList();
              checkConflict(scheduleId, 'course', courseId);
            });
            form.on('radio(tclass)', function(tclass) {
              var tclassId = tclass.value;
              $('#currentTclassId').attr('value', tclassId);
              clearConflict();
              clearCourseList();
              checkConflict(scheduleId, 'tclass', tclassId);
            });
            form.render();
          }
        });
      }
  
      function clearConflict() {
        $('td').each(function(index, elem) {
          td = $(elem);
          td.attr('disabled', false);
          td.removeAttr('class');
        });
      }
      
      function clearCourseList() {
        var currentCourseId = $('#currentCourseId').attr('value');
        $('input:radio[name="course"][value="' + currentCourseId + '"]').attr('checked', false);
        $('#currentCourseId').attr('value', '');
        form.render();
      }
      
      function clearTclassList() {
        var currentTclassId = $('#currentTclassId').attr('value');
        $('input:radio[name="tclass"][value="' + currentTclassId + '"]').attr('checked', false);
        $('#currentTclassId').attr('value', '');
        form.render();
      }
  
      function clickTable(arrangement) {
        $('#currentPeriodId').attr('value', arrangement.periodId);
        var scheduleId = $('#currentScheduleId').attr('value');
        if(arrangement.type == 'tclass') {
          $('#currentType').attr('value', 'tclass');
          $('#currentTclassId').attr('value', arrangement.tclassId);
          var currentCourseId = $('#currentCourseId').attr('value');
          var clickedCourseId = arrangement.courseId;
          if (isNull(currentCourseId)) {
            if (!isNull(clickedCourseId)) {
              alert("current0:" + currentCourseId + "clicked1:" + clickedCourseId);
              $('#currentCourseId').attr('value', clickedCourseId);
              cancel();
              display();
              $('input:radio[name="course"][value="' + clickedCourseId + '"]').attr('checked', true);
              form.render();
              checkConflict(scheduleId, 'course', clickedCourseId);
            }
          } else {
            if (!isNull(clickedCourseId)) {
              alert("current1:" + currentCourseId + "clicked1:" + clickedCourseId);
              arrange();
              $('#currentCourseId').attr('value', clickedCourseId);
              cancel();
              display();
              $('input:radio[name="course"][value="' + clickedCourseId + '"]').attr('checked', true);
              form.render();
              checkConflict(scheduleId, 'course', clickedCourseId);
            } else {
              alert("current1:" + currentCourseId + "clicked0:" + clickedCourseId);
              arrange();
              display();
              $('input:radio[name="course"][value="' + currentCourseId + '"]').attr('checked', true);
              form.render();
              checkConflict(scheduleId, 'course', currentCourseId);
            }
          }
        } else if(arrangement.type == 'teacher') {
          $('#currentType').attr('value', 'teacher');
          $('#currentTeacherId').attr('value', arrangement.teacherId);
          var currentTclassId = $('#currentTclassId').attr('value');
          var clickedTclassId = arrangement.tclassId;
          if (isNull(currentTclassId)) {
            if (!isNull(clickedTclassId)) {
              alert("current0:" + currentTclassId + "clicked1:" + clickedTclassId);
              $('#currentTclassId').attr('value', clickedTclassId);
              cancel();
              display();
              $('input:radio[name="tclass"][value="' + clickedTclassId + '"]').attr('checked', true);
              form.render();
              checkConflict(scheduleId, 'tclass', clickedTclassId);
            }
          } else {
            if (!isNull(clickedTclassId)) {
              alert("current1:" + currentTclassId + "clicked1:" + clickedTclassId);
              arrange();
              $('#currentTclassId').attr('value', clickedTclassId);
              cancel();
              display();
              $('input:radio[name="tclass"][value="' + clickedTclassId + '"]').attr('checked', true);
              form.render();
              checkConflict(scheduleId, 'tclass', clickedTclassId);
            } else {
              alert("current1:" + currentTclassId + "clicked0:" + clickedTclassId);
              arrange();
              display();
              $('input:radio[name="tclass"][value="' + currentTclassId + '"]').attr('checked', true);
              form.render();
              checkConflict(scheduleId, 'tclass', currentTclassId);
            }
          }
        }
      }
  
      function arrange() {
        $.ajax({
          async : false,
          url : '/arrangement/arrange',
          type : 'POST',
          dataType : 'json',
          contentType : 'application/json',
          data : JSON.stringify($('#arrangementView').serializeJSON()),
          success : function(result) {
          }
        });
      }
  
      function cancel() {
        $.ajax({
          async : false,
          url : '/arrangement/cancel/',
          type : 'POST',
          dataType : 'json',
          contentType : 'application/json',
          data : JSON.stringify($('#arrangementView').serializeJSON()),
          success : function(result) {
          }
        })
      }
  
      function checkConflict(scheduleId, type, typeId) {
        $.ajax({
          async : false,
          url : '/arrangement/check/schedule/' + scheduleId + '/' + type + '/' + typeId,
          type : 'GET',
          success : function(conflictList) {
            $.each(conflictList, function(index, conflict) {
              var periodView = $('#' + conflict.periodViewId);
              if (conflict.conflictValue == 0) {
                periodView.attr('disabled', false);
                periodView.attr('class', 'layui-bg-green');
              } else if (conflict.conflictValue == 1) {
                periodView.attr('disabled', true);
                periodView.attr('class', 'layui-disabled layui-bg-red');
              }
            });
          }
        })
      }
  
      function isNull(obj) {
        return null == obj || '' == obj;
      }
  
  </script>
</body>

</html>
