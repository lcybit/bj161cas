<!DOCTYPE html>
<html>

<head>
<title>排课信息展示</title>
<link rel="stylesheet" href="/plugin/layui/css/layui.css" />
<script src="/plugin/jquery/jquery.js"></script>
<script src="/plugin/jquery/jquery.serializejson.js"></script>
<script src="/plugin/jsrender/jsrender.js"></script>
</head>

<body>
  <div class="layui-container" style="width:100%;">
    <form class="layui-form layui-form-pane" id="periodViewInfo" method="get"></form>
    <div class="layui-row" id="scheduleView"></div>
  </div>
  <script id="tmpl-periodViewInfo" type="text/x-jsrender">
    <div class="layui-form-item">
      <label class="layui-form-label">当前课表ID:</label>
      <div class="layui-input-block">
        <input class="layui-input" type="text" name="scheduleId" id="currentScheduleId">
      </div>
    </div>
    <div class="layui-form-item">
      <label class="layui-form-label">选中课时ID:</label>
      <div class="layui-input-block">
        <input class="layui-input" type="text" name="periodViewId" id="chosenPeriodViewId">
      </div>
    </div>
    <div class="layui-form-item">
      <label class="layui-form-label">选中课程ID:</label>
      <div class="layui-input-block">
        <input class="layui-input" type="text">
      </div>
    </div>
    <div class="layui-form-item" pane="">
      <label class="layui-form-label">display3选中课程:</label>
      <div class="layui-input-block">
        {{for courseList tmpl="#tmpl-course" /}}
      </div>
    </div>
  </script>
  <script id="tmpl-scheduleView" type="text/x-jsrender">
    {{for weekViewList tmpl="#tmpl-weekView" /}}
  </script>
  <script id="tmpl-course" type="text/x-jsrender">
    <input type="radio" name="arrangement[course][courseId]" id="chosenCourseId" value="{{:courseId}}" title="{{:name}}" onclick="alert()">
  </script>
  <script id="tmpl-weekView" type="text/x-jsrender">
    <div class="layui-col-md3">
      <table class="layui-table" lay-size="sm">
        <tbody>
          <tr>
            <td rowspan="2"></td>
            <td colspan="{{:#parent.parent.data.schedule.forenoon}}">上午</td>
            <td colspan="{{:#parent.parent.data.schedule.afternoon}}">下午</td>
          </tr>
          <tr>
            <td>早</td>
            <td>1</td>
            <td>2</td>
            <td>3</td>
            <td>4</td>
            <td>5</td>
            <td>6</td>
            <td>7</td>
          </tr>
			{{for dayViewList tmpl="#tmpl-dayView" /}}
        </tbody>
      </table>
      <table class="layui-table" lay-size="sm">
        <tr>
          {{for courseViewList tmpl="#tmpl-courseView" /}}
        </tr>
      </table>
    </div>
  </script>
  <script id="tmpl-dayView" type="text/x-jsrender">
    <tr>
      <td>{{:#getIndex() +1}}</td>
      {{for periodViewList tmpl="#tmpl-periodView" /}}
    </tr>
  </script>
  <script id="tmpl-periodView" type="text/x-jsrender">
	<td id="{{:periodViewId}}"
        style="cursor:pointer"
        onclick="clickTable({'periodViewId':'{{:periodViewId}}','courseId':'{{:arrangement.course.courseId}}'})">
      {{:arrangement.course.name}}</td>
  </script>
  <script id="tmpl-courseView" type="text/x-jsrender">
    <td>{{:course.name}}{{:periodNum-arrangedNum}}</td>
  </script>
  <script>
    $(document).ready(function() {
      var scheduleId = sessionStorage.getItem('currentScheduleId');
      $.ajax({
        async : false,
        url : '/schedule/display/' + scheduleId,
        type : 'GET',
        success : function(scheduleView) {
          $('#periodViewInfo').html($.templates('#tmpl-periodViewInfo').render(scheduleView));
        }
      });
      $('#currentScheduleId').attr('value', scheduleId);
      display();
      $('input:radio[name="arrangement\[course\]\[courseId\]"]').change(function(periodView){       
        if($(this).is(":checked")){  
          chosenCourse(periodView);  
        }else{  
          alert(0);  
        }        
       }); 
      layui.form.render();
    })
      
    function chosenCourse(periodView){
      //$('#chosenPeriodViewId').attr('value', periodView.periodViewId);
      var chosenCourseId = $('input:radio[name="arrangement\[course\]\[courseId\]"]:checked').val();
      checkConflict(scheduleId, chosenCourseId);
    }
    
    function display() {
      var scheduleId = sessionStorage.getItem('currentScheduleId');
      $.ajax({
        async : false,
        url : '/schedule/display/' + scheduleId,
        type : 'GET',
        success : function(scheduleView) {
          $('#scheduleView').html($.templates('#tmpl-scheduleView').render(scheduleView));
        }
      });
    }
  
    function clickTable(periodView) {
      $('#chosenPeriodViewId').attr('value', periodView.periodViewId);
      var chosenCourseId = $('input:radio[name="arrangement\[course\]\[courseId\]"]:checked').val();
   
      //var chosenCourseId = $('#chosenCourseId').attr('value');
      var scheduleId = $('#currentScheduleId').attr('value');
      var clickedCourseId = periodView.courseId;
      if (null == chosenCourseId || '' == chosenCourseId) {
        if (null != clickedCourseId && '' != clickedCourseId) {
          alert("course0:"+chosenCourseId+"click1:"+clickedCourseId)
        //  $('#chosenCourseId').attr('value', periodView.courseId);
          cancel();
          checkConflict(scheduleId, clickedCourseId);
        }
      } else {
        if (null != clickedCourseId && '' != clickedCourseId) {
          alert("course1:"+chosenCourseId+"click1:"+clickedCourseId)
          arrange();
         // $('#chosenCourseId').attr('value', periodView.courseId);
          cancel();
          checkConflict(scheduleId, clickedCourseId);
        } else {
          alert("course1:"+chosenCourseId+"click0:"+clickedCourseId)
          arrange();
          checkConflict(scheduleId, chosenCourseId);
        }
      }
    }
  
    function arrange() {
      $.ajax({
        async : false,
        url : '/arrangement/arrange',
        type : 'POST',
        dataType : 'json',
        contentType : 'application/json',
        data : JSON.stringify($('#periodViewInfo').serializeJSON()),
        success : function(result) {
          display();
        }
      });
    }
  
    function cancel() {
      $.ajax({
        async : false,
        url : '/arrangement/cancel/',
        type : 'POST',
        dataType : 'json',
        contentType : 'application/json',
        data : JSON.stringify($('#periodViewInfo').serializeJSON()),
        success : function(result) {
          display();
        }
      })
    }
  
    function checkConflict(scheduleId, courseId) {
      $.ajax({
        async : false,
        url : '/arrangement/check/schedule/' + scheduleId + '/course/' + courseId,
        type : 'GET',
        success : function(conflictList) {
          $.each(conflictList, function(index, conflict) {
            var periodViewId = $('#' + conflict.periodViewId);
            if(conflict.conflictValue == 0) {
              periodViewId.attr('class', 'layui-bg-green');
            } else if(conflict.conflictValue == 1) {
              periodViewId.removeAttr('onclick');
              periodViewId.attr('class', 'layui-disabled layui-bg-red');
            }
          });
        }
      })
    }
  </script>
</body>

</html>
